% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/conscape_prep.R
\name{conscape_prep}
\alias{conscape_prep}
\title{Prepare rasters and tiles for \code{run_conscape()}}
\usage{
conscape_prep(
  tile_d,
  tile_trim,
  asc_dir = NULL,
  r_target,
  r_mov,
  r_src,
  target_threshold = 0,
  clear_dir = FALSE,
  landmark = 10L,
  progress = TRUE
)
}
\arguments{
\item{tile_d}{Target interior tile width in map units (e.g., meters).
Internally, tile dimensions are converted to a number of cells and rounded
up to the nearest multiple of \code{landmark} to ensure that coarse–graining
windows in ConScape align across tiles.}

\item{tile_trim}{Minimum overlap width between neighbouring tiles, in map
units. The actual overlap used may be increased so that the overlap in
cells is a multiple of \code{landmark}. This overlap is removed again in
\code{\link[=mosaic_conscape]{mosaic_conscape()}}.}

\item{asc_dir}{Directory where \code{.asc} tiles and ancillary files will be
written. If \code{NULL} (default), a new directory is created under the current
R session's temporary directory.}

\item{r_target}{\code{SpatRaster} representing target qualities. May be the same
object as \code{r_src}. Values below \code{target_threshold} are treated as
unsuitable and are masked out.}

\item{r_mov}{\code{SpatRaster} representing movement probabilities.}

\item{r_src}{\code{SpatRaster} representing source qualities. May be the same
object as \code{r_target}.}

\item{target_threshold}{Numeric threshold applied to \code{r_target} to define
suitable habitat (default \code{0}). Cells with values \verb{< target_threshold} are
coded as 0 in the mask and set to \code{NA} in the tiled target raster.}

\item{clear_dir}{Logical (default \code{FALSE}). If \code{TRUE}, any existing contents
of \code{asc_dir} are deleted before tiles are written. If \code{FALSE} and
\code{asc_dir} is not empty, the function stops with an error.}

\item{landmark}{Integer giving the number of pixels in the coarse–graining
window used by ConScape (the \code{npix} argument in \code{coarse_graining()};
default \code{10L}). This value is used to ensure that tile dimensions and
overlaps are aligned with the coarse–graining grid.}

\item{progress}{Logical. If \code{TRUE}, simple text messages are printed to
report tiling progress.}
}
\value{
A named list of class \code{"ConScapeRtools_prep"} with elements:
\itemize{
\item \code{cs_tiles} – \code{SpatVector} of interior tile polygons.
\item \code{tile_num} – integer vector of tile IDs that contain usable data.
\item \code{asc_dir} – path to the root directory where \code{.asc} tiles and the mask
were written.
\item \code{src}, \code{target}, \code{mov} – subdirectories containing the source, target,
and movement tiles (as \code{.asc} files).
\item \code{tile_trim} – effective overlap width in map units (may be larger than
the user–supplied \code{tile_trim} if increased for landmark alignment).
\item \code{landmark} – the coarse–graining window size passed in via \code{landmark}.
}

This object is intended to be passed directly to \code{\link[=run_conscape]{run_conscape()}}.
}
\description{
Convenience wrapper that (i) checks that all input rasters are compatible,
(ii) designs a landmark–aligned tiling scheme with \code{make_tiles()}, (iii)
applies the same tiling to the target, source, and movement rasters via
\code{tile_rast()}, and (iv) writes a binary mask that is used later by
\code{\link[=run_conscape]{run_conscape()}} and \code{\link[=mosaic_conscape]{mosaic_conscape()}}.
}
\details{
All three rasters (\code{r_target}, \code{r_mov}, \code{r_src}) must have identical extent
and resolution; this is checked at the start of the function. The CRS is not
modified but should be the same for all layers.

A binary mask (\code{mask.asc}) is written to \code{file.path(asc_dir, "mask")} and
contains 1 for cells with \code{r_target >= target_threshold} and 0 otherwise.
This mask is used later to restrict the mosaicked ConScape outputs to the
potentially occupiable landscape.

Tiles are designed once internally using \code{make_tiles()} based on the thresholded target
raster, and the same tile geometry is then applied internally to all layers via the
\code{tile_rast()}. Tile sizes and overlaps are expressed in cell units and
rounded so that both tile width and overlap are multiples of \code{landmark},
which ensures that ConScape's coarse–grained "landmarks" fall on a common
grid when tiles are reassembled.
}
\examples{
\dontrun{
library(ConScapeRtools)

## Import data
s <- system.file("data/suitability.asc", package = "ConScapeRtools")
source <- terra::rast(s)

a <- system.file("data/affinity.asc", package = "ConScapeRtools")
resist <- terra::rast(a)

jl_home <- "/path/to/julia/bin"

td <- tile_design(r_mov = resist,
                  r_source = source,
                  max_d = 7000,
                  theta = 0.1,
                  jl_home = jl_home)

## Tile dimension
tile_d <- td$tile_d

# How much to trim tiles
tile_trim <- td$tile_trim

# Makes computation more efficient
landmark <- 5L # Must be an integer, not numeric

# Controls level of randomness of paths
theta <- td$theta

# Controls rate of decay with distance
exp_d <- td$exp_d

## Prepare data for analysis
prep <- conscape_prep(tile_d = tile_d,
                      tile_trim = tile_trim,
                      r_target = source,
                      r_mov = resist,
                      r_src = source,
                      clear_dir = T,
                      landmark = landmark)

cs_res <- run_conscape(conscape_prep = prep,
                       out_dir = "conscape_out",
                       jl_home = jl_home)
}

}
\seealso{
\code{\link[=run_conscape]{run_conscape()}}, \code{\link[=mosaic_conscape]{mosaic_conscape()}}
}
\author{
Bill Peterman
}
